# -*- coding:utf-8 -*-
import torch
import copy
import time
from time import sleep
import socket
import json
import numpy as np
import json
from tools import rodrigues2bshapes, euler2quat
from joint_map import gvh2blender, gvh2plugin, plugin2ue
from temp_pose import JOINT_NUM

ip = "192.168.1.10"
upd_port = 3001

data_load = torch.load("./hmr4d_results.pt")
true = True
false = False

temp = {"action_state":0,"body_format":2,"confidence":95.0,"coordinate_system":2,"coordinate_unit":0,"frame_id":160,"global_root_orientation":{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},"global_root_posititon":{"x":0.0,"y":0.0,"z":0.0},"id":1,"is_new":true,"keypoint":[{"x":0.0,"y":0.0,"z":0.0},{"x":0.0,"y":1.0,"z":0.0},{"x":0.0,"y":2.0,"z":0.0},{"x":0.0,"y":3.0,"z":0.0},{"x":0.0,"y":4.0,"z":0.0},{"x":0.0,"y":4.5,"z":0.0},{"x":-0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":-0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":-0.5,"y":3.5,"z":0.0},{"x":0.5,"y":3.5,"z":0.0},{"x":-1.0,"y":3.5,"z":0.0},{"x":1.0,"y":3.5,"z":0.0},{"x":-1.5,"y":3.0,"z":0.0},{"x":1.5,"y":3.0,"z":0.0},{"x":-2.0,"y":2.5,"z":0.0},{"x":2.0,"y":2.5,"z":0.0},{"x":-0.5,"y":0.0,"z":0.0},{"x":0.5,"y":0.0,"z":0.0},{"x":-0.5,"y":-1.0,"z":0.0},{"x":0.5,"y":-1.0,"z":0.0},{"x":-0.5,"y":-2.0,"z":0.0},{"x":0.5,"y":-2.0,"z":0.0},{"x":-0.5,"y":-2.5,"z":0.0},{"x":0.5,"y":-2.5,"z":0.0},{"x":-0.5,"y":-2.5,"z":-0.10000000149011612},{"x":0.5,"y":-2.5,"z":-0.10000000149011612},{"x":-0.5,"y":-2.0,"z":-0.10000000149011612},{"x":0.5,"y":-2.0,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":0.10000000149011612},{"x":2.0,"y":2.5,"z":0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.10000000149011612},{"x":2.0,"y":2.5,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.20000000298023224},{"x":2.0,"y":2.5,"z":-0.20000000298023224},{"x":-2.0,"y":2.5,"z":-0.30000001192092896},{"x":2.0,"y":2.5,"z":-0.30000001192092896}],"keypoint_confidence":[100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0],"local_orientation_per_joint":[{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591}],"local_position_per_joint":[{"x":0.0,"y":0.0,"z":0.0},{"x":0.0,"y":1.0,"z":0.0},{"x":0.0,"y":2.0,"z":0.0},{"x":0.0,"y":3.0,"z":0.0},{"x":0.0,"y":4.0,"z":0.0},{"x":0.0,"y":4.5,"z":0.0},{"x":-0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":-0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":-0.5,"y":3.5,"z":0.0},{"x":0.5,"y":3.5,"z":0.0},{"x":-1.0,"y":3.5,"z":0.0},{"x":1.0,"y":3.5,"z":0.0},{"x":-1.5,"y":3.0,"z":0.0},{"x":1.5,"y":3.0,"z":0.0},{"x":-2.0,"y":2.5,"z":0.0},{"x":2.0,"y":2.5,"z":0.0},{"x":-0.5,"y":0.0,"z":0.0},{"x":0.5,"y":0.0,"z":0.0},{"x":-0.5,"y":-1.0,"z":0.0},{"x":0.5,"y":-1.0,"z":0.0},{"x":-0.5,"y":-2.0,"z":0.0},{"x":0.5,"y":-2.0,"z":0.0},{"x":-0.5,"y":-2.5,"z":0.0},{"x":0.5,"y":-2.5,"z":0.0},{"x":-0.5,"y":-2.5,"z":-0.10000000149011612},{"x":0.5,"y":-2.5,"z":-0.10000000149011612},{"x":-0.5,"y":-2.0,"z":-0.10000000149011612},{"x":0.5,"y":-2.0,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":0.10000000149011612},{"x":2.0,"y":2.5,"z":0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.10000000149011612},{"x":2.0,"y":2.5,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.20000000298023224},{"x":2.0,"y":2.5,"z":-0.20000000298023224},{"x":-2.0,"y":2.5,"z":-0.30000001192092896},{"x":2.0,"y":2.5,"z":-0.30000001192092896}],"nb_bodies":1,"position":{"x":1.0,"y":2.0,"z":3.0},"role":2,"timestamp":1734966480568014974,"tracking_state":1}

# world视角
# [1147(帧率), 63(21个关键点 估计是绝对旋转)]
body_pose = data_load["smpl_params_global"]["body_pose"]
orient = data_load["smpl_params_global"]["global_orient"] # root朝向
trans = data_load["smpl_params_global"]["transl"] # root位移
frames_len = trans.shape[0]  # 总帧率


def create_frame_data(now_frame = 0):

    body_pose_ = body_pose[now_frame].tolist()
    orient_ = orient[now_frame].tolist()
    trans_ = trans[now_frame].tolist()
    format_data = copy.deepcopy(temp)
    #print(orient_)
    #print(rodrigues2bshapes(orient_))  # 这里不对，因为数据文件中的旋转都是轴角表示

    """
    将22个joint映射成 {plugin_joint_name: 姿势}
    """
    gvh_bone_namse = list(gvh2plugin.keys())
    # print(gvh_bone_namse)
    # print("________")
    gvh2plugin_joint_data = {}
    for item_joint in range(0, int(len(body_pose_)/3)):
        assert item_joint <= 21,u"joint-num是22个"
        start_index = 3*item_joint
        end_index = 3*(item_joint+1)
        #print(start_index, end_index)
        #print(body_pose_[start_index:end_index])
        gvh_joint_name = gvh_bone_namse[item_joint+1]  # 0是root，所以这里是从1开始的
        plugine_joint_name = gvh2plugin[gvh_joint_name]
        #print("gvh_joint_name:{a}, plugine_joint_name:{b}".format(a=gvh_joint_name, b=plugine_joint_name))
        if plugine_joint_name:
            gvh2plugin_joint_data[plugine_joint_name] = rodrigues2bshapes(body_pose_[start_index:end_index])
        else:
            pass
            #print("miss joint:{a}".format(a=gvh_joint_name))
    #print("匹配到的plugin关节num：{a}".format(a=len(gvh2plugin_joint_data)))

    all_joint_data = []  # [0, "PELVIS", euler2quat([0,0,0])], 共38组
    counter = 0
    for plugin_joint_index in plugin2ue:
        temp_joint = [counter, plugin_joint_index,
                    gvh2plugin_joint_data.get(plugin_joint_index, euler2quat([0,0,0]))]
        #print(temp_joint)
        all_joint_data.append(temp_joint[2])
        counter += 1

    format_data["local_orientation_per_joint"] = all_joint_data  # 局部朝向
    format_data["global_root_orientation"] = rodrigues2bshapes(orient_)  # 四元数
    format_data["global_root_posititon"] = trans_  # 位移
    format_data["timestamp"] = time.time_ns()
    format_data["frame_id"] = now_frame
    # print(format_data)
    return format_data




with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:
    s.connect((ip, upd_port))
    frame_id = 0
    import tqdm
    for i in tqdm.tqdm(range(frames_len)):
        if True:
            #data_str = "hahaha:" + str(time.time())
            assert frame_id < frames_len, u"frame_id必须<frames_len"
            data_str = json.dumps(create_frame_data(frame_id))
            frame_id += 1
            #print(data_str)
            #print("\n\n")
            s.sendall(data_str.encode())  # 真实的发送数据
        sleep(0.015)  # 粗糙的控制帧率











































