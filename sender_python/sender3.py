# -*- coding:utf-8 -*-
import torch
import copy
import numpy as np
import json
from tools import rodrigues2bshapes
from joint_map import gvh2blender, gvh2plugin, plugin2ue

data_load = torch.load("./hmr4d_results.pt")
true = True
false = False

temp = {"action_state":0,"body_format":2,"confidence":95.0,"coordinate_system":2,"coordinate_unit":0,"frame_id":160,"global_root_orientation":{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},"global_root_posititon":{"x":0.0,"y":0.0,"z":0.0},"id":1,"is_new":true,"keypoint":[{"x":0.0,"y":0.0,"z":0.0},{"x":0.0,"y":1.0,"z":0.0},{"x":0.0,"y":2.0,"z":0.0},{"x":0.0,"y":3.0,"z":0.0},{"x":0.0,"y":4.0,"z":0.0},{"x":0.0,"y":4.5,"z":0.0},{"x":-0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":-0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":-0.5,"y":3.5,"z":0.0},{"x":0.5,"y":3.5,"z":0.0},{"x":-1.0,"y":3.5,"z":0.0},{"x":1.0,"y":3.5,"z":0.0},{"x":-1.5,"y":3.0,"z":0.0},{"x":1.5,"y":3.0,"z":0.0},{"x":-2.0,"y":2.5,"z":0.0},{"x":2.0,"y":2.5,"z":0.0},{"x":-0.5,"y":0.0,"z":0.0},{"x":0.5,"y":0.0,"z":0.0},{"x":-0.5,"y":-1.0,"z":0.0},{"x":0.5,"y":-1.0,"z":0.0},{"x":-0.5,"y":-2.0,"z":0.0},{"x":0.5,"y":-2.0,"z":0.0},{"x":-0.5,"y":-2.5,"z":0.0},{"x":0.5,"y":-2.5,"z":0.0},{"x":-0.5,"y":-2.5,"z":-0.10000000149011612},{"x":0.5,"y":-2.5,"z":-0.10000000149011612},{"x":-0.5,"y":-2.0,"z":-0.10000000149011612},{"x":0.5,"y":-2.0,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":0.10000000149011612},{"x":2.0,"y":2.5,"z":0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.10000000149011612},{"x":2.0,"y":2.5,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.20000000298023224},{"x":2.0,"y":2.5,"z":-0.20000000298023224},{"x":-2.0,"y":2.5,"z":-0.30000001192092896},{"x":2.0,"y":2.5,"z":-0.30000001192092896}],"keypoint_confidence":[100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0,100.0],"local_orientation_per_joint":[{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591},{"w":-0.22990426421165466,"x":0.0,"y":0.8097623586654663,"z":0.5398415923118591}],"local_position_per_joint":[{"x":0.0,"y":0.0,"z":0.0},{"x":0.0,"y":1.0,"z":0.0},{"x":0.0,"y":2.0,"z":0.0},{"x":0.0,"y":3.0,"z":0.0},{"x":0.0,"y":4.0,"z":0.0},{"x":0.0,"y":4.5,"z":0.0},{"x":-0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":0.10000000149011612,"y":4.5,"z":0.10000000149011612},{"x":-0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":0.20000000298023224,"y":4.0,"z":-0.10000000149011612},{"x":-0.5,"y":3.5,"z":0.0},{"x":0.5,"y":3.5,"z":0.0},{"x":-1.0,"y":3.5,"z":0.0},{"x":1.0,"y":3.5,"z":0.0},{"x":-1.5,"y":3.0,"z":0.0},{"x":1.5,"y":3.0,"z":0.0},{"x":-2.0,"y":2.5,"z":0.0},{"x":2.0,"y":2.5,"z":0.0},{"x":-0.5,"y":0.0,"z":0.0},{"x":0.5,"y":0.0,"z":0.0},{"x":-0.5,"y":-1.0,"z":0.0},{"x":0.5,"y":-1.0,"z":0.0},{"x":-0.5,"y":-2.0,"z":0.0},{"x":0.5,"y":-2.0,"z":0.0},{"x":-0.5,"y":-2.5,"z":0.0},{"x":0.5,"y":-2.5,"z":0.0},{"x":-0.5,"y":-2.5,"z":-0.10000000149011612},{"x":0.5,"y":-2.5,"z":-0.10000000149011612},{"x":-0.5,"y":-2.0,"z":-0.10000000149011612},{"x":0.5,"y":-2.0,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":0.10000000149011612},{"x":2.0,"y":2.5,"z":0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.10000000149011612},{"x":2.0,"y":2.5,"z":-0.10000000149011612},{"x":-2.0,"y":2.5,"z":-0.20000000298023224},{"x":2.0,"y":2.5,"z":-0.20000000298023224},{"x":-2.0,"y":2.5,"z":-0.30000001192092896},{"x":2.0,"y":2.5,"z":-0.30000001192092896}],"nb_bodies":1,"position":{"x":1.0,"y":2.0,"z":3.0},"role":2,"timestamp":1734966480568014974,"tracking_state":1}

# world视角
# [1147(帧率), 63(21个关键点 估计是绝对旋转)]
body_pose = data_load["smpl_params_global"]["body_pose"]
orient = data_load["smpl_params_global"]["global_orient"] # root朝向
trans = data_load["smpl_params_global"]["transl"] # root位移
frames = trans.shape[0]

now = 0



body_pose_ = body_pose[now].tolist()
orient_ = orient[now].tolist()
trans_ = trans[now].tolist()
format_data = copy.deepcopy(temp)
#print(orient_)
#print(rodrigues2bshapes(orient_))  # 这里不对，因为数据文件中的旋转都是轴角表示

format_data["global_root_orientation"] = rodrigues2bshapes(orient_)  # 四元数
format_data["global_root_posititon"] = trans_  # 位移


all_joint_data = {gvh_bone_namse[0]: rodrigues2bshapes(orient_)}
gvh_bone_namse = list(gvh2blender.keys())
for item_joint in range(1, int(len(body_pose_)/3)+1):
    start_index = 3*item_joint
    end_index = 3*(item_joint+1)
    #print(start_index, end_index)
    print(body_pose_[start_index:end_index])
    all_joint_data[gvh_bone_namse[item_joint]] = rodrigues2bshapes(body_pose_[start_index:end_index])
print("gvh data full后，joint-num:{a}".format(a=len(all_joint_data)))


gvh2plugin_data = {}
for item_joint_name in all_joint_data:
    joint_data = all_joint_data[item_joint_name]
    plugin_joint_name_ = gvh2plugin[item_joint_name]
    if plugin_joint_name_:
        gvh2plugin_data[plugin_joint_name_] = joint_data
print("映射plguin后，joint-num:{a}".format(a=len(gvh2plugin_data)))


# plugin2ue_data = {}
# for item_joint_name in gvh2plugin_data:
#     joint_data = gvh2plugin_data[item_joint_name]
#     ue_joint_name_ = plugin2ue[item_joint_name]
#     if plugin_joint_name_:
#         plugin2ue_data[ue_joint_name_] = joint_data
# print("映射plguin后，joint-num:{a}".format(a=len(plugin2ue_data)))








format_data["local_orientation_per_joint"] = all_joint_data  # 局部朝向

print(format_data)






















if __name__ == "__main__":
    pass




data_load = torch.load("./hmr4d_results.pt")
body_pose = data_load["smpl_params_global"]["body_pose"]
orient = data_load["smpl_params_global"]["global_orient"] # root朝向
trans = data_load["smpl_params_global"]["transl"] # root位移

t=body_pose.tolist()


new_res = []
for i in t:
    new_res.append([ii/np.pi*180 for ii in i])


































